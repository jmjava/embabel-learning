# Commit Summaries: guide

**Generated:** Sat Jan  3 01:19:44 PM EST 2026
**Repository:** embabel/guide
**Commits:** 10

---


## Commit 1: d2d4a93

**Message:** Use graph object manager for user ops  
**Author:** jasper blues <jasper@liberation-data.com>  
**Date:** 2026-01-02 10:25:51  
**Hash:** d2d4a938dc7c6b772a50e366a4170296380e4076  
**Summary:**  12 files changed, 777 insertions(+), 14 deletions(-)

### Files Changed

```
 pom.xml                                            |  58 ++-
 src/main/java/com/embabel/GuideApplication.java    |   7 +
 .../com/embabel/guide/domain/AnonymousGuideUser.kt |  28 ++
 .../embabel/guide/domain/AnonymousWebUserData.kt   |  16 +-
 .../embabel/guide/domain/DiscordUserInfoData.kt    |   6 +-
 .../guide/domain/GraphObjectGuideUserRepository.kt | 131 +++++++
 .../kotlin/com/embabel/guide/domain/GuideUser.kt   |  46 +++
 .../com/embabel/guide/domain/GuideUserData.kt      |   7 +-
 .../embabel/guide/domain/GuideUserRepository.kt    |  81 +++++
 .../kotlin/com/embabel/guide/domain/WebUserData.kt |   6 +-
 .../drivine/GraphObjectGuideUserRepositoryTest.kt  | 403 +++++++++++++++++++++
 src/test/resources/application-test.yml            |   2 +-
 12 files changed, 777 insertions(+), 14 deletions(-)
```

### File List

- **Modified:** `pom.xml`
- **Modified:** `src/main/java/com/embabel/GuideApplication.java`
- **Added:** `src/main/kotlin/com/embabel/guide/domain/AnonymousGuideUser.kt`
- **Modified:** `src/main/kotlin/com/embabel/guide/domain/AnonymousWebUserData.kt`
- **Modified:** `src/main/kotlin/com/embabel/guide/domain/DiscordUserInfoData.kt`
- **Added:** `src/main/kotlin/com/embabel/guide/domain/GraphObjectGuideUserRepository.kt`
- **Added:** `src/main/kotlin/com/embabel/guide/domain/GuideUser.kt`
- **Modified:** `src/main/kotlin/com/embabel/guide/domain/GuideUserData.kt`
- **Added:** `src/main/kotlin/com/embabel/guide/domain/GuideUserRepository.kt`
- **Modified:** `src/main/kotlin/com/embabel/guide/domain/WebUserData.kt`
- **Added:** `src/test/kotlin/com/embabel/guide/domain/drivine/GraphObjectGuideUserRepositoryTest.kt`
- **Modified:** `src/test/resources/application-test.yml`

### Code Changes

```diff
diff --git a/pom.xml b/pom.xml
index 259b815..3238551 100644
--- a/pom.xml
+++ b/pom.xml
@@ -19,7 +19,7 @@
     <properties>
         <java.version>21</java.version>
         <embabel-agent.version>0.3.1</embabel-agent.version>
-        <kotlin.version>2.0.20</kotlin.version>
+        <kotlin.version>2.2.0</kotlin.version>
     </properties>
 
     <dependencies>
@@ -35,12 +35,18 @@
             <groupId>com.embabel.agent</groupId>
             <artifactId>embabel-agent-rag-neo-drivine</artifactId>
             <version>0.1.1-SNAPSHOT</version>
+            <exclusions>
+                <exclusion>
+                    <groupId>org.drivine</groupId>
+                    <artifactId>drivine4j</artifactId>
+                </exclusion>
+            </exclusions>
         </dependency>
 
         <dependency>
             <groupId>org.drivine</groupId>
             <artifactId>drivine4j-spring-boot-starter</artifactId>
-            <version>0.0.8</version>
+            <version>0.0.12</version>
         </dependency>
 
 
@@ -168,6 +174,52 @@
                 <groupId>org.springframework.boot</groupId>
                 <artifactId>spring-boot-maven-plugin</artifactId>
             </plugin>
+
+            <!-- Run Gradle KSP to generate Drivine DSL code -->
+            <plugin>
+                <groupId>org.codehaus.mojo</groupId>
+                <artifactId>exec-maven-plugin</artifactId>
+                <version>3.5.0</version>
+                <executions>
+                    <execution>
+                        <id>gradle-ksp-codegen</id>
+                        <phase>generate-sources</phase>
+                        <goals>
+                            <goal>exec</goal>
+                        </goals>
+                        <configuration>
+                            <executable>${project.basedir}/codegen-gradle/gradlew</executable>
+                            <workingDirectory>${project.basedir}/codegen-gradle</workingDirectory>
+                            <arguments>
+                                <argument>kspKotlin</argument>
+                                <argument>--quiet</argument>
+                            </arguments>
+                        </configuration>
+                    </execution>
+                </executions>
+            </plugin>
+
+            <!-- Include Gradle-generated sources in Maven build -->
+            <plugin>
+                <groupId>org.codehaus.mojo</groupId>
+                <artifactId>build-helper-maven-plugin</artifactId>
+                <version>3.6.0</version>
+                <executions>
+                    <execution>
+                        <id>add-ksp-generated-sources</id>
+                        <phase>generate-sources</phase>
+                        <goals>
+                            <goal>add-source</goal>
+                        </goals>
+                        <configuration>
+                            <sources>
+                                <source>${project.basedir}/codegen-gradle/build/generated/ksp/main/kotlin</source>
+                            </sources>
+                        </configuration>
+                    </execution>
+                </executions>
+            </plugin>
+
             <plugin>
                 <groupId>org.jetbrains.kotlin</groupId>
                 <artifactId>kotlin-maven-plugin</artifactId>
@@ -183,6 +235,7 @@
                             <sourceDirs>
                                 <sourceDir>${project.basedir}/src/main/kotlin</sourceDir>
                                 <sourceDir>${project.basedir}/src/main/java</sourceDir>
+                                <sourceDir>${project.basedir}/codegen-gradle/build/generated/ksp/main/kotlin</sourceDir>
                             </sourceDirs>
                         </configuration>
                     </execution>
@@ -204,6 +257,7 @@
                     <args>
                         <arg>-Xjsr305=strict</arg>
                         <arg>-Xskip-metadata-version-check</arg>
+                        <arg>-Xcontext-parameters</arg>
                     </args>
                     <compilerPlugins>
                         <plugin>spring</plugin>
diff --git a/src/main/java/com/embabel/GuideApplication.java b/src/main/java/com/embabel/GuideApplication.java
index 5d77c76..ad73bc1 100644
--- a/src/main/java/com/embabel/GuideApplication.java
+++ b/src/main/java/com/embabel/GuideApplication.java
@@ -17,6 +17,8 @@ package com.embabel;
 
 import org.drivine.autoconfigure.EnableDrivine;
 import org.drivine.autoconfigure.EnableDrivinePropertiesConfig;
+import org.drivine.manager.GraphObjectManager;
+import org.drivine.manager.GraphObjectManagerFactory;
 import org.drivine.manager.PersistenceManager;
 import org.drivine.manager.PersistenceManagerFactory;
 import org.springframework.boot.SpringApplication;
@@ -44,4 +46,9 @@ public class GuideApplication {
     public PersistenceManager neoManager(PersistenceManagerFactory factory) {
         return factory.get("neo");
     }
+
+    @Bean("neoGraphObjectManager")
+    public GraphObjectManager neoGraphObjectManager(GraphObjectManagerFactory factory) {
+        return factory.get("neo");
+    }
 }
diff --git a/src/main/kotlin/com/embabel/guide/domain/AnonymousGuideUser.kt b/src/main/kotlin/com/embabel/guide/domain/AnonymousGuideUser.kt
new file mode 100644
index 0000000..eb3a3b4
--- /dev/null
+++ b/src/main/kotlin/com/embabel/guide/domain/AnonymousGuideUser.kt
@@ -0,0 +1,28 @@
+package com.embabel.guide.domain
+
+import org.drivine.annotation.Direction
+import org.drivine.annotation.GraphRelationship
+import org.drivine.annotation.GraphView
+import org.drivine.annotation.Root
+
+/**
+ * GraphView specifically for GuideUsers with anonymous WebUser relationships.
+ * The AnonymousWebUserData has labels ["WebUser", "Anonymous"] which ensures
+ * only anonymous users are matched.
+ */
+@GraphView
+data class AnonymousGuideUser(
+    @Root
+    val core: GuideUserData,
+
+    @GraphRelationship(type = "IS_WEB_USER", direction = Direction.OUTGOING)
+    val webUser: AnonymousWebUserData
+) {
+    /**
+     * Convert to the unified GuideUser type for consistent API.
+     */
+    fun toGuideUser(): GuideUser = GuideUser(
+        core = core,
+        webUser = webUser
+    )
+}
\ No newline at end of file
diff --git a/src/main/kotlin/com/embabel/guide/domain/AnonymousWebUserData.kt b/src/main/kotlin/com/embabel/guide/domain/AnonymousWebUserData.kt
index 91746ab..48de6c8 100644
--- a/src/main/kotlin/com/embabel/guide/domain/AnonymousWebUserData.kt
+++ b/src/main/kotlin/com/embabel/guide/domain/AnonymousWebUserData.kt
@@ -1,21 +1,23 @@
 package com.embabel.guide.domain
 
 import com.fasterxml.jackson.annotation.JsonIgnoreProperties
+import org.drivine.annotation.NodeFragment
 
 /**
- * Data representation for anonymous web users.
- * Extends WebUserData to add the Anonymous label distinction.
+ * Node fragment for anonymous web users.
+ * Has both WebUser and Anonymous labels in the graph.
  */
+@NodeFragment(labels = ["WebUser", "Anonymous"])
 @JsonIgnoreProperties(ignoreUnknown = true)
 class AnonymousWebUserData(
-    userId: String,
-    userDisplayName: String,
-    userUsername: String,
+    id: String,
+    displayName: String,
+    userName: String,
     userEmail: String?,
     passwordHash: String?,
     refreshToken: String?
-) : WebUserData(userId, userDisplayName, userUsername, userEmail, passwordHash, refreshToken) {
+) : WebUserData(id, displayName, userName, userEmail, passwordHash, refreshToken) {
 
     override fun toString(): String =
-        "AnonymousWebUserData{userId='$id', userDisplayName='$displayName', userUsername='$userName'}"
+        "AnonymousWebUserData{id='$id', displayName='$displayName', userName='$userName'}"
 }
diff --git a/src/main/kotlin/com/embabel/guide/domain/DiscordUserInfoData.kt b/src/main/kotlin/com/embabel/guide/domain/DiscordUserInfoData.kt
index 7af32f0..c8b050e 100644
--- a/src/main/kotlin/com/embabel/guide/domain/DiscordUserInfoData.kt
+++ b/src/main/kotlin/com/embabel/guide/domain/DiscordUserInfoData.kt
@@ -2,12 +2,16 @@ package com.embabel.guide.domain
```

---


*Note: Diff truncated (showing first 200 lines of 963 total)*


## Commit 2: acb0dbd

**Message:** Convert domain to Kotlin (so we can use typed DSL with drivine).  
**Author:** jasper blues <jasper@liberation-data.com>  
**Date:** 2025-12-31 08:41:40  
**Hash:** acb0dbd14d020f52dd1a51aff9c0b6cc0926dcb3  
**Summary:**  30 files changed, 497 insertions(+), 906 deletions(-)

### Files Changed

```
 src/main/java/com/embabel/guide/ChatActions.java   |   8 +-
 .../com/embabel/guide/domain/GuideUserService.java |  98 ---------
 .../guide/domain/drivine/AnonymousWebUserData.java |  33 ---
 .../domain/drivine/DiscordUserInfoAdapter.java     |  53 -----
 .../guide/domain/drivine/DiscordUserInfoData.java  |  92 --------
 .../guide/domain/drivine/GuideUserData.java        |  72 ------
 .../guide/domain/drivine/GuideUserMapper.java      |  87 --------
 .../drivine/GuideUserWithDiscordUserInfo.java      | 115 ----------
 .../guide/domain/drivine/GuideUserWithWebUser.java |  85 -------
 .../embabel/guide/domain/drivine/WebUserData.java  |  99 ---------
 .../chat/listener/WebSocketConnectionListener.kt   |   2 +-
 .../security/AnonymousPrincipalHandshakeHandler.kt |   3 +-
 .../guide/chat/service/GuideRagServiceAdapter.kt   |   2 +-
 .../embabel/guide/domain/AnonymousWebUserData.kt   |  21 ++
 .../embabel/guide/domain/DiscordUserInfoData.kt    |  32 +++
 .../guide/domain/DrivineGuideUserRepository.kt}    | 244 ++++++++++-----------
 .../com/embabel/guide/domain/GuideUserData.kt      |  17 ++
 .../com/embabel/guide/domain/GuideUserMapper.kt    |  70 ++++++
 .../com/embabel/guide/domain/GuideUserService.kt   |  99 +++++++++
 .../guide/domain/GuideUserWithDiscordUserInfo.kt   |  59 +++++
 .../embabel/guide/domain/GuideUserWithWebUser.kt   |  34 +++
 .../guide/domain/HasDiscordUserInfoData.kt}        |   9 +-
 .../com/embabel/guide/domain/HasGuideUserData.kt}  |   9 +-
 .../com/embabel/guide/domain/HasWebUserData.kt}    |   9 +-
 .../kotlin/com/embabel/guide/domain/WebUserData.kt |  19 ++
 .../kotlin/com/embabel/hub/HubApiController.kt     |   2 +-
 src/main/kotlin/com/embabel/hub/HubService.kt      |  10 +-
 .../embabel/guide/domain/GuideUserServiceTest.kt   |   1 -
 .../drivine/DrivineGuideUserRepositoryTest.kt      |   4 +
 .../kotlin/com/embabel/hub/HubApiControllerTest.kt |  15 +-
 30 files changed, 497 insertions(+), 906 deletions(-)
```

### File List

- **Modified:** `src/main/java/com/embabel/guide/ChatActions.java`
- **Deleted:** `src/main/java/com/embabel/guide/domain/GuideUserService.java`
- **Deleted:** `src/main/java/com/embabel/guide/domain/drivine/AnonymousWebUserData.java`
- **Deleted:** `src/main/java/com/embabel/guide/domain/drivine/DiscordUserInfoAdapter.java`
- **Deleted:** `src/main/java/com/embabel/guide/domain/drivine/DiscordUserInfoData.java`
- **Deleted:** `src/main/java/com/embabel/guide/domain/drivine/GuideUserData.java`
- **Deleted:** `src/main/java/com/embabel/guide/domain/drivine/GuideUserMapper.java`
- **Deleted:** `src/main/java/com/embabel/guide/domain/drivine/GuideUserWithDiscordUserInfo.java`
- **Deleted:** `src/main/java/com/embabel/guide/domain/drivine/GuideUserWithWebUser.java`
- **Deleted:** `src/main/java/com/embabel/guide/domain/drivine/WebUserData.java`
- **Modified:** `src/main/kotlin/com/embabel/guide/chat/listener/WebSocketConnectionListener.kt`
- **Modified:** `src/main/kotlin/com/embabel/guide/chat/security/AnonymousPrincipalHandshakeHandler.kt`
- **Modified:** `src/main/kotlin/com/embabel/guide/chat/service/GuideRagServiceAdapter.kt`
- **Added:** `src/main/kotlin/com/embabel/guide/domain/AnonymousWebUserData.kt`
- **Added:** `src/main/kotlin/com/embabel/guide/domain/DiscordUserInfoData.kt`
- **Renamed:** `R052` → `src/main/java/com/embabel/guide/domain/drivine/DrivineGuideUserRepository.java	src/main/kotlin/com/embabel/guide/domain/DrivineGuideUserRepository.kt`
- **Added:** `src/main/kotlin/com/embabel/guide/domain/GuideUserData.kt`
- **Added:** `src/main/kotlin/com/embabel/guide/domain/GuideUserMapper.kt`
- **Added:** `src/main/kotlin/com/embabel/guide/domain/GuideUserService.kt`
- **Added:** `src/main/kotlin/com/embabel/guide/domain/GuideUserWithDiscordUserInfo.kt`
- **Added:** `src/main/kotlin/com/embabel/guide/domain/GuideUserWithWebUser.kt`
- **Renamed:** `R055` → `src/main/java/com/embabel/guide/domain/drivine/HasDiscordUserInfoData.java	src/main/kotlin/com/embabel/guide/domain/HasDiscordUserInfoData.kt`
- **Renamed:** `R060` → `src/main/java/com/embabel/guide/domain/drivine/HasGuideUserData.java	src/main/kotlin/com/embabel/guide/domain/HasGuideUserData.kt`
- **Renamed:** `R055` → `src/main/java/com/embabel/guide/domain/drivine/HasWebUserData.java	src/main/kotlin/com/embabel/guide/domain/HasWebUserData.kt`
- **Added:** `src/main/kotlin/com/embabel/guide/domain/WebUserData.kt`
- **Modified:** `src/main/kotlin/com/embabel/hub/HubApiController.kt`
- **Modified:** `src/main/kotlin/com/embabel/hub/HubService.kt`
- **Modified:** `src/test/kotlin/com/embabel/guide/domain/GuideUserServiceTest.kt`
- **Modified:** `src/test/kotlin/com/embabel/guide/domain/drivine/DrivineGuideUserRepositoryTest.kt`
- **Modified:** `src/test/kotlin/com/embabel/hub/HubApiControllerTest.kt`

### Code Changes

```diff
diff --git a/src/main/java/com/embabel/guide/ChatActions.java b/src/main/java/com/embabel/guide/ChatActions.java
index 5d3c203..528bf28 100644
--- a/src/main/java/com/embabel/guide/ChatActions.java
+++ b/src/main/java/com/embabel/guide/ChatActions.java
@@ -10,10 +10,10 @@ import com.embabel.agent.rag.tools.ToolishRag;
 import com.embabel.agent.rag.tools.TryHyDE;
 import com.embabel.chat.Conversation;
 import com.embabel.chat.UserMessage;
-import com.embabel.guide.domain.drivine.DrivineGuideUserRepository;
-import com.embabel.guide.domain.drivine.GuideUserWithDiscordUserInfo;
-import com.embabel.guide.domain.drivine.GuideUserWithWebUser;
-import com.embabel.guide.domain.drivine.HasGuideUserData;
+import com.embabel.guide.domain.DrivineGuideUserRepository;
+import com.embabel.guide.domain.GuideUserWithDiscordUserInfo;
+import com.embabel.guide.domain.GuideUserWithWebUser;
+import com.embabel.guide.domain.HasGuideUserData;
 import com.embabel.guide.rag.DataManager;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
diff --git a/src/main/java/com/embabel/guide/domain/GuideUserService.java b/src/main/java/com/embabel/guide/domain/GuideUserService.java
deleted file mode 100644
index 117e188..0000000
--- a/src/main/java/com/embabel/guide/domain/GuideUserService.java
+++ /dev/null
@@ -1,98 +0,0 @@
-package com.embabel.guide.domain;
-
-import com.embabel.guide.domain.drivine.*;
-import org.springframework.stereotype.Service;
-
-import java.util.Optional;
-import java.util.UUID;
-
-@Service
-public class GuideUserService {
-
-    private final DrivineGuideUserRepository guideUserRepository;
-
-    public GuideUserService(DrivineGuideUserRepository guideUserRepository) {
-        this.guideUserRepository = guideUserRepository;
-    }
-
-    /**
-     * Returns the anonymous web user for non-authenticated sessions.
-     * If the user doesn't exist yet, creates it with a random UUID and displayName "Friend".
-     * <p>
-     * Synchronized to prevent race condition where multiple concurrent requests
-     * could create duplicate GuideUser instances.
-     *
-     * @return the anonymous web user GuideUser
-     */
-    public synchronized GuideUserWithWebUser findOrCreateAnonymousWebUser() {
-        return guideUserRepository.findAnonymousWebUser()
-            .orElseGet(() -> {
-                // Double-check after acquiring lock to avoid duplicate creation
-                var existing = guideUserRepository.findAnonymousWebUser();
-                if (existing.isPresent()) {
-                    return existing.get();
-                }
-
-                var guideUser = new GuideUserData(UUID.randomUUID().toString(), null, null);
-                var anonymousWebUser = new AnonymousWebUserData(UUID.randomUUID().toString(), "Friend", "anonymous", null, null, null);
-
-                return guideUserRepository.createWithWebUser(guideUser, anonymousWebUser);
-            });
-    }
-
-    /**
-     * Finds a GuideUser by their WebUser ID.
-     *
-     * @param webUserId the WebUser's ID
-     * @return the HasGuideUser composite if found
-     */
-    public Optional<HasGuideUserData> findByWebUserId(String webUserId) {
-        return guideUserRepository.findByWebUserId(webUserId)
-            .map(composed -> (HasGuideUserData) composed);
-    }
-
-    /**
-     * Creates and saves a new GuideUser from a WebUser.
-     *
-     * @param webUser the WebUser to create a GuideUser from
-     * @return the saved GuideUser composite
-     */
-    public GuideUserWithWebUser saveFromWebUser(WebUserData webUser) {
-        var guideUser = new GuideUserData(UUID.randomUUID().toString(), null, null);
-        return guideUserRepository.createWithWebUser(guideUser, webUser);
-    }
-
-    /**
-     * Finds a GuideUser by their username.
-     *
-     * @param username the username to search for
-     * @return the GuideUser if found, null otherwise
-     */
-    public Optional<GuideUserWithWebUser> findByWebUserName(String username) {
-        return guideUserRepository.findByWebUserName(username);
-    }
-
-    /**
-     * Updates the persona for a user.
-     *
-     * @param userId  the user's ID
-     * @param persona the persona name to set
-     * @return the updated GuideUser
-     */
-    public HasGuideUserData updatePersona(String userId, String persona) {
-        guideUserRepository.updatePersona(userId, persona);
-        return guideUserRepository.findById(userId)
-            .orElseThrow(() -> new IllegalArgumentException("User not found: " + userId));
-    }
-
-    /**
-     * Saves a GuideUser.
-     *
-     * @param guideUser the GuideUser to save
-     * @return the saved HasGuideUser composite
-     */
-    public HasGuideUserData saveUser(GuideUserData guideUser) {
-        return guideUserRepository.save(guideUser);
-    }
-
-}
diff --git a/src/main/java/com/embabel/guide/domain/drivine/AnonymousWebUserData.java b/src/main/java/com/embabel/guide/domain/drivine/AnonymousWebUserData.java
deleted file mode 100644
index f37b20b..0000000
--- a/src/main/java/com/embabel/guide/domain/drivine/AnonymousWebUserData.java
+++ /dev/null
@@ -1,33 +0,0 @@
-package com.embabel.guide.domain.drivine;
-
-import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
-import org.jetbrains.annotations.Nullable;
-
-/**
- * Data representation for anonymous web users.
- * Extends WebUserData to add the Anonymous label distinction.
- */
-@JsonIgnoreProperties(ignoreUnknown = true)
-public class AnonymousWebUserData extends WebUserData {
-
-    // No-arg constructor for Jackson
-    // TODO: I think jackson module covers this?
-    public AnonymousWebUserData() {
-        super();
-    }
-
-    public AnonymousWebUserData(String userId, String userDisplayName, String userUsername,
-                                @Nullable String userEmail, @Nullable String passwordHash,
-                                @Nullable String refreshToken) {
-        super(userId, userDisplayName, userUsername, userEmail, passwordHash, refreshToken);
-    }
-
-    @Override
-    public String toString() {
-        return "AnonymousWebUserData{" +
-            "userId='" + getId() + '\'' +
-            ", userDisplayName='" + getDisplayName() + '\'' +
-            ", userUsername='" + getUserName() + '\'' +
-            '}';
-    }
-}
diff --git a/src/main/java/com/embabel/guide/domain/drivine/DiscordUserInfoAdapter.java b/src/main/java/com/embabel/guide/domain/drivine/DiscordUserInfoAdapter.java
deleted file mode 100644
index dca9464..0000000
--- a/src/main/java/com/embabel/guide/domain/drivine/DiscordUserInfoAdapter.java
+++ /dev/null
@@ -1,53 +0,0 @@
-package com.embabel.guide.domain.drivine;
-
-import com.embabel.agent.discord.DiscordUserInfo;
-import org.jetbrains.annotations.NotNull;
-import org.jetbrains.annotations.Nullable;
-
-/**
- * Adapter to convert DiscordUserInfoData to DiscordUserInfo interface.
- * Used when converting composed Drivine results back to domain entities.
- */
-public class DiscordUserInfoAdapter implements DiscordUserInfo {
-
-    private final DiscordUserInfoData data;
-
-    public DiscordUserInfoAdapter(DiscordUserInfoData data) {
-        this.data = data;
-    }
-
-    @NotNull
-    @Override
-    public String getId() {
-        return data.getId();
-    }
-
-    @NotNull
-    @Override
-    public String getUsername() {
-        return data.getUsername();
-    }
-
-    @NotNull
-    @Override
```

---


*Note: Diff truncated (showing first 200 lines of 1903 total)*


## Commit 3: 823a9a1

**Message:** Clean up exception handling - use boot std format.  
**Author:** jasper blues <jasper@liberation-data.com>  
**Date:** 2025-12-28 12:12:38  
**Hash:** 823a9a1c02bd343b9a1393849d655be674255ff2  
**Summary:**  6 files changed, 136 insertions(+), 78 deletions(-)

### Files Changed

```
 .../domain/drivine/DrivineGuideUserRepository.java | 18 ++++++
 .../kotlin/com/embabel/hub/HubApiController.kt     | 65 +++++-----------------
 .../kotlin/com/embabel/hub/HubExceptionHandler.kt  | 54 ++++++++++++++++++
 .../com/embabel/hub/StandardErrorResponse.kt       | 11 ++++
 .../com/embabel/hub/UnauthorizedException.kt       |  3 +
 .../kotlin/com/embabel/hub/HubApiControllerTest.kt | 63 +++++++++++----------
 6 files changed, 136 insertions(+), 78 deletions(-)
```

### File List

- **Modified:** `src/main/java/com/embabel/guide/domain/drivine/DrivineGuideUserRepository.java`
- **Modified:** `src/main/kotlin/com/embabel/hub/HubApiController.kt`
- **Added:** `src/main/kotlin/com/embabel/hub/HubExceptionHandler.kt`
- **Added:** `src/main/kotlin/com/embabel/hub/StandardErrorResponse.kt`
- **Added:** `src/main/kotlin/com/embabel/hub/UnauthorizedException.kt`
- **Modified:** `src/test/kotlin/com/embabel/hub/HubApiControllerTest.kt`

### Code Changes

```diff
diff --git a/src/main/java/com/embabel/guide/domain/drivine/DrivineGuideUserRepository.java b/src/main/java/com/embabel/guide/domain/drivine/DrivineGuideUserRepository.java
index c9b61cb..7854ef3 100644
--- a/src/main/java/com/embabel/guide/domain/drivine/DrivineGuideUserRepository.java
+++ b/src/main/java/com/embabel/guide/domain/drivine/DrivineGuideUserRepository.java
@@ -286,6 +286,24 @@ public class DrivineGuideUserRepository {
         );
     }
 
+    /**
+     * Delete GuideUsers where username starts with the given prefix (for test cleanup)
+     */
+    @Transactional
+    public void deleteByUsernameStartingWith(String prefix) {
+        String cypher = """
+            MATCH (u:GuideUser)-[:IS_WEB_USER]->(w:WebUser)
+            WHERE toLower(w.userName) STARTS WITH toLower($prefix)
+            DETACH DELETE u, w
+            """;
+
+        manager.execute(
+            QuerySpecification
+                .withStatement(cypher)
+                .bind(Map.of("prefix", prefix))
+        );
+    }
+
     /**
      * Find all GuideUsers (for testing)
      */
diff --git a/src/main/kotlin/com/embabel/hub/HubApiController.kt b/src/main/kotlin/com/embabel/hub/HubApiController.kt
index 00c2bc1..b46cdb3 100644
--- a/src/main/kotlin/com/embabel/hub/HubApiController.kt
+++ b/src/main/kotlin/com/embabel/hub/HubApiController.kt
@@ -1,7 +1,6 @@
 package com.embabel.hub
 
-import org.springframework.http.HttpStatus
-import org.springframework.http.ResponseEntity
+import com.embabel.guide.domain.drivine.GuideUserWithWebUser
 import org.springframework.security.core.Authentication
 import org.springframework.web.bind.annotation.GetMapping
 import org.springframework.web.bind.annotation.PostMapping
@@ -17,36 +16,19 @@ class HubApiController(
     private val personaService: PersonaService
 ) {
 
-    data class ErrorResponse(val error: String)
-
     @PostMapping("/register")
-    fun registerUser(@RequestBody request: UserRegistrationRequest): ResponseEntity<*> {
-        return try {
-            val user = hubService.registerUser(request)
-            ResponseEntity.ok(user)
-        } catch (e: RegistrationException) {
-            ResponseEntity
-                .status(HttpStatus.BAD_REQUEST)
-                .body(ErrorResponse(e.message ?: "Registration failed"))
-        }
+    fun registerUser(@RequestBody request: UserRegistrationRequest): GuideUserWithWebUser {
+        return hubService.registerUser(request)
     }
 
     @PostMapping("/login")
-    fun loginUser(@RequestBody request: UserLoginRequest): ResponseEntity<*> {
-        return try {
-            val loginResponse = hubService.loginUser(request)
-            ResponseEntity.ok(loginResponse)
-        } catch (e: LoginException) {
-            ResponseEntity
-                .status(HttpStatus.UNAUTHORIZED)
-                .body(ErrorResponse(e.message ?: "Login failed"))
-        }
+    fun loginUser(@RequestBody request: UserLoginRequest): LoginResponse {
+        return hubService.loginUser(request)
     }
 
     @GetMapping("/personas")
-    fun listPersonas(): ResponseEntity<List<PersonaService.Persona>> {
-        val personas = personaService.listPersonas()
-        return ResponseEntity.ok(personas)
+    fun listPersonas(): List<PersonaService.Persona> {
+        return personaService.listPersonas()
     }
 
     data class UpdatePersonaRequest(val persona: String)
@@ -55,36 +37,19 @@ class HubApiController(
     fun updateMyPersona(
         @RequestBody request: UpdatePersonaRequest,
         authentication: Authentication?
-    ): ResponseEntity<Void> {
-        return try {
-            // Get user ID from authentication
-            val userId = authentication?.principal as? String
-                ?: return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build()
-
-            // Update the persona
-            hubService.updatePersona(userId, request.persona)
-            ResponseEntity.ok().build()
-        } catch (e: IllegalArgumentException) {
-            ResponseEntity.status(HttpStatus.BAD_REQUEST).build()
-        }
+    ) {
+        val userId = authentication?.principal as? String
+            ?: throw UnauthorizedException()
+        hubService.updatePersona(userId, request.persona)
     }
 
     @PutMapping("/password")
     fun changePassword(
         @RequestBody request: ChangePasswordRequest,
         authentication: Authentication?
-    ): ResponseEntity<*> {
-        return try {
-            val userId = authentication?.principal as? String
-                ?: return ResponseEntity.status(HttpStatus.UNAUTHORIZED)
-                    .body(ErrorResponse("Unauthorized"))
-
-            hubService.changePassword(userId, request)
-            ResponseEntity.ok().build<Void>()
-        } catch (e: ChangePasswordException) {
-            ResponseEntity
-                .status(HttpStatus.BAD_REQUEST)
-                .body(ErrorResponse(e.message ?: "Password change failed"))
-        }
+    ) {
+        val userId = authentication?.principal as? String
+            ?: throw UnauthorizedException()
+        hubService.changePassword(userId, request)
     }
 }
diff --git a/src/main/kotlin/com/embabel/hub/HubExceptionHandler.kt b/src/main/kotlin/com/embabel/hub/HubExceptionHandler.kt
new file mode 100644
index 0000000..98eb8da
--- /dev/null
+++ b/src/main/kotlin/com/embabel/hub/HubExceptionHandler.kt
@@ -0,0 +1,54 @@
+package com.embabel.hub
+
+import jakarta.servlet.http.HttpServletRequest
+import org.springframework.core.annotation.Order
+import org.springframework.http.HttpStatus
+import org.springframework.http.ResponseEntity
+import org.springframework.http.converter.HttpMessageNotReadableException
+import org.springframework.web.bind.annotation.ExceptionHandler
+import org.springframework.web.bind.annotation.RestControllerAdvice
+import java.time.Instant
+
+@RestControllerAdvice
+@Order(1)
+class HubExceptionHandler {
+
+    @ExceptionHandler(RegistrationException::class)
+    fun handleRegistrationException(ex: RegistrationException, request: HttpServletRequest) =
+        buildResponse(HttpStatus.BAD_REQUEST, ex.message, request)
+
+    @ExceptionHandler(LoginException::class)
+    fun handleLoginException(ex: LoginException, request: HttpServletRequest) =
+        buildResponse(HttpStatus.UNAUTHORIZED, ex.message, request)
+
+    @ExceptionHandler(ChangePasswordException::class)
+    fun handleChangePasswordException(ex: ChangePasswordException, request: HttpServletRequest) =
+        buildResponse(HttpStatus.BAD_REQUEST, ex.message, request)
+
+    @ExceptionHandler(UnauthorizedException::class)
+    fun handleUnauthorizedException(ex: UnauthorizedException, request: HttpServletRequest) =
+        buildResponse(HttpStatus.UNAUTHORIZED, ex.message, request)
+
+    @ExceptionHandler(IllegalArgumentException::class)
+    fun handleIllegalArgumentException(ex: IllegalArgumentException, request: HttpServletRequest) =
+        buildResponse(HttpStatus.BAD_REQUEST, ex.message, request)
+
+    @ExceptionHandler(HttpMessageNotReadableException::class)
+    fun handleHttpMessageNotReadableException(ex: HttpMessageNotReadableException, request: HttpServletRequest) =
+        buildResponse(HttpStatus.BAD_REQUEST, "Invalid request body", request)
+
+    private fun buildResponse(
+        status: HttpStatus,
+        message: String?,
+        request: HttpServletRequest
+    ): ResponseEntity<StandardErrorResponse> {
+        val errorResponse = StandardErrorResponse(
+            timestamp = Instant.now(),
+            status = status.value(),
+            error = status.reasonPhrase,
+            message = message ?: "An error occurred",
+            path = request.requestURI
+        )
+        return ResponseEntity.status(status).body(errorResponse)
+    }
+}
\ No newline at end of file
diff --git a/src/main/kotlin/com/embabel/hub/StandardErrorResponse.kt b/src/main/kotlin/com/embabel/hub/StandardErrorResponse.kt
new file mode 100644
index 0000000..dd45632
--- /dev/null
+++ b/src/main/kotlin/com/embabel/hub/StandardErrorResponse.kt
@@ -0,0 +1,11 @@
+package com.embabel.hub
+
+import java.time.Instant
```

---


*Note: Diff truncated (showing first 200 lines of 454 total)*


## Commit 4: ecf56fa

**Message:** Publish reports for CICD builds.  
**Author:** jasper blues <jasper@liberation-data.com>  
**Date:** 2025-12-27 19:56:06  
**Hash:** ecf56fa47e741915aac347b605eaff52381905e2  
**Summary:**  2 files changed, 28 insertions(+)

### Files Changed

```
 .github/workflows/maven.yml |  6 ++++++
 pom.xml                     | 22 ++++++++++++++++++++++
 2 files changed, 28 insertions(+)
```

### File List

- **Modified:** `.github/workflows/maven.yml`
- **Modified:** `pom.xml`

### Code Changes

```diff
diff --git a/.github/workflows/maven.yml b/.github/workflows/maven.yml
index 8909401..59525c5 100644
--- a/.github/workflows/maven.yml
+++ b/.github/workflows/maven.yml
@@ -8,6 +8,12 @@ on:
   pull_request:
     types: [ opened, synchronize, reopened ]
 
+# Required for dorny/test-reporter to create check runs
+permissions:
+  contents: read
+  checks: write
+  pull-requests: write
+
 jobs:
   build:
     runs-on: ubuntu-latest
diff --git a/pom.xml b/pom.xml
index f3c5b61..259b815 100644
--- a/pom.xml
+++ b/pom.xml
@@ -245,6 +245,28 @@
                     </execution>
                 </executions>
             </plugin>
+
+            <!-- JaCoCo for code coverage -->
+            <plugin>
+                <groupId>org.jacoco</groupId>
+                <artifactId>jacoco-maven-plugin</artifactId>
+                <version>0.8.12</version>
+                <executions>
+                    <execution>
+                        <id>prepare-agent</id>
+                        <goals>
+                            <goal>prepare-agent</goal>
+                        </goals>
+                    </execution>
+                    <execution>
+                        <id>report</id>
+                        <phase>test</phase>
+                        <goals>
+                            <goal>report</goal>
+                        </goals>
+                    </execution>
+                </executions>
+            </plugin>
         </plugins>
     </build>
 
```

---


## Commit 5: 15f3499

**Message:** Fix tests.  
**Author:** jasper blues <jasper@liberation-data.com>  
**Date:** 2025-12-27 19:27:54  
**Hash:** 15f34991e03b8c2c24288b343a3c72fca7e5fd0c  
**Summary:**  6 files changed, 66 insertions(+), 86 deletions(-)

### Files Changed

```
 .github/workflows/maven.yml                        | 59 +++++++++++++----
 pom.xml                                            |  2 +-
 src/main/java/com/embabel/GuideApplication.java    | 13 ++++
 .../com/embabel/guide/config/DrivineConfig.java    | 73 ----------------------
 .../com/embabel/guide/TestApplicationContext.kt    |  2 +-
 .../embabel/guide/chat/security/McpSecurityTest.kt |  3 +
 6 files changed, 66 insertions(+), 86 deletions(-)
```

### File List

- **Modified:** `.github/workflows/maven.yml`
- **Modified:** `pom.xml`
- **Modified:** `src/main/java/com/embabel/GuideApplication.java`
- **Deleted:** `src/main/java/com/embabel/guide/config/DrivineConfig.java`
- **Modified:** `src/test/kotlin/com/embabel/guide/TestApplicationContext.kt`
- **Modified:** `src/test/kotlin/com/embabel/guide/chat/security/McpSecurityTest.kt`

### Code Changes

```diff
diff --git a/.github/workflows/maven.yml b/.github/workflows/maven.yml
index 3703b6b..8909401 100644
--- a/.github/workflows/maven.yml
+++ b/.github/workflows/maven.yml
@@ -1,11 +1,6 @@
 # This workflow will build a Java / Kotlin project with Maven, and cache/restore any dependencies to improve the workflow execution time
 # For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-maven
 
-# This workflow uses actions that are not certified by GitHub.
-# They are provided by a third-party and are governed by
-# separate terms of service, privacy policy, and support
-# documentation.
-
 name: Build
 
 on:
@@ -15,24 +10,66 @@ on:
 
 jobs:
   build:
-
     runs-on: ubuntu-latest
 
     steps:
       - uses: actions/checkout@v4
+
       - name: Set up JDK 21
         uses: actions/setup-java@v4
         with:
           java-version: '21'
           distribution: 'temurin'
           cache: maven
+
       - name: Configure Testcontainers
         run: |
           mkdir -p /home/runner
           echo "testcontainers.reuse.enable=true" > /home/runner/.testcontainers.properties
-      - name: Build and analyze
+
+      # Compile first - fail fast on compilation errors
+      - name: Compile
+        run: mvn -B compile test-compile
+
+      # Run tests with JaCoCo coverage
+      - name: Test with Coverage
         env:
-          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed to get PR information, if any
-          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
-          OPENAI_API_KEY: ${{ secrets.OPENAI_API_DUMMY_KEY }} # Dummy key for testing only
-        run: mvn -U -B test verify
+          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
+          OPENAI_API_KEY: ${{ secrets.OPENAI_API_DUMMY_KEY }}
+        run: mvn -B test
+
+      # Generate JaCoCo coverage report
+      - name: Generate Coverage Report
+        if: always()
+        run: mvn -B jacoco:report
+        continue-on-error: true
+
+      # Publish test results as check run annotations
+      - name: Publish Test Results
+        uses: dorny/test-reporter@v1
+        if: always()
+        with:
+          name: Test Results
+          path: target/surefire-reports/*.xml
+          reporter: java-junit
+          fail-on-error: false
+
+      # Upload test reports as artifacts
+      - name: Upload Test Reports
+        uses: actions/upload-artifact@v4
+        if: always()
+        with:
+          name: test-reports
+          path: |
+            target/surefire-reports/
+            target/site/jacoco/
+          retention-days: 14
+
+      # Upload coverage to Codecov (optional - requires CODECOV_TOKEN secret)
+      - name: Upload Coverage to Codecov
+        uses: codecov/codecov-action@v4
+        if: always()
+        continue-on-error: true
+        with:
+          files: target/site/jacoco/jacoco.xml
+          fail_ci_if_error: false
\ No newline at end of file
diff --git a/pom.xml b/pom.xml
index 16d5ffc..f3c5b61 100644
--- a/pom.xml
+++ b/pom.xml
@@ -40,7 +40,7 @@
         <dependency>
             <groupId>org.drivine</groupId>
             <artifactId>drivine4j-spring-boot-starter</artifactId>
-            <version>0.0.6</version>
+            <version>0.0.8</version>
         </dependency>
 
 
diff --git a/src/main/java/com/embabel/GuideApplication.java b/src/main/java/com/embabel/GuideApplication.java
index d7f5eab..5d77c76 100644
--- a/src/main/java/com/embabel/GuideApplication.java
+++ b/src/main/java/com/embabel/GuideApplication.java
@@ -15,20 +15,33 @@
  */
 package com.embabel;
 
+import org.drivine.autoconfigure.EnableDrivine;
+import org.drivine.autoconfigure.EnableDrivinePropertiesConfig;
+import org.drivine.manager.PersistenceManager;
+import org.drivine.manager.PersistenceManagerFactory;
 import org.springframework.boot.SpringApplication;
 import org.springframework.boot.WebApplicationType;
 import org.springframework.boot.autoconfigure.SpringBootApplication;
 import org.springframework.boot.context.properties.ConfigurationPropertiesScan;
+import org.springframework.context.annotation.Bean;
 import org.springframework.scheduling.annotation.EnableScheduling;
 
 
 @SpringBootApplication
 @ConfigurationPropertiesScan
 @EnableScheduling
+@EnableDrivine
+@EnableDrivinePropertiesConfig
 public class GuideApplication {
+
     public static void main(String[] args) {
         SpringApplication app = new SpringApplication(GuideApplication.class);
         app.setWebApplicationType(WebApplicationType.SERVLET);
         app.run(args);
     }
+
+    @Bean("neo")
+    public PersistenceManager neoManager(PersistenceManagerFactory factory) {
+        return factory.get("neo");
+    }
 }
diff --git a/src/main/java/com/embabel/guide/config/DrivineConfig.java b/src/main/java/com/embabel/guide/config/DrivineConfig.java
deleted file mode 100644
index 086b70c..0000000
--- a/src/main/java/com/embabel/guide/config/DrivineConfig.java
+++ /dev/null
@@ -1,73 +0,0 @@
-package com.embabel.guide.config;
-
-import org.drivine.connection.ConnectionProperties;
-import org.drivine.connection.DataSourceMap;
-import org.drivine.connection.DatabaseType;
-import org.drivine.manager.PersistenceManager;
-import org.drivine.manager.PersistenceManagerFactory;
-import org.springframework.beans.factory.annotation.Value;
-import org.springframework.context.annotation.Bean;
-import org.springframework.context.annotation.ComponentScan;
-import org.springframework.context.annotation.Configuration;
-import org.springframework.context.annotation.Profile;
-
-/**
- * Configuration for Drivine4j Neo4j client.
- * This provides an alternative to Neo4j OGM with a composition-based approach.
- */
-@Configuration
-@ComponentScan("org.drivine")
-public class DrivineConfig {
-
-    @Value("${NEO4J_URI:bolt://localhost:7687}")
-    private String neo4jUri;
-
-    @Value("${NEO4J_USERNAME:neo4j}")
-    private String username;
-
-    @Value("${NEO4J_PASSWORD:brahmsian}")
-    private String password;
-
-    @Value("${NEO4J_DATABASE:neo4j}")
-    private String database;
-
-    @Bean
-    @Profile("local & !test")
-    public DataSourceMap dataSourceMap() {
-        // Parse the URI to extract host and port
-        String host = "localhost";
-        int port = 7687;
-
-        if (neo4jUri.startsWith("bolt://")) {
-            String hostPort = neo4jUri.substring(7);
-            String[] parts = hostPort.split(":");
-            if (parts.length > 0) {
-                host = parts[0];
-            }
-            if (parts.length > 1) {
-                port = Integer.parseInt(parts[1]);
-            }
-        }
-
-        ConnectionProperties props = new ConnectionProperties(
-            DatabaseType.NEO4J,
```

---


*Note: Diff truncated (showing first 200 lines of 259 total)*


## Commit 6: 27f13f9

**Message:** Fix tests (probably).  
**Author:** jasper blues <jasper@liberation-data.com>  
**Date:** 2025-12-27 17:03:47  
**Hash:** 27f13f9db3b0b27a2871beb669550441b68ce2d6  
**Summary:**  1 file changed, 1 insertion(+), 1 deletion(-)

### Files Changed

```
 pom.xml | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)
```

### File List

- **Modified:** `pom.xml`

### Code Changes

```diff
diff --git a/pom.xml b/pom.xml
index 0e37993..16d5ffc 100644
--- a/pom.xml
+++ b/pom.xml
@@ -40,7 +40,7 @@
         <dependency>
             <groupId>org.drivine</groupId>
             <artifactId>drivine4j-spring-boot-starter</artifactId>
-            <version>0.0.5</version>
+            <version>0.0.6</version>
         </dependency>
 
 
```

---


## Commit 7: 0c3311f

**Message:** Use DrivineStore::info() for stats endpoint.  
**Author:** jasper blues <jasper@liberation-data.com>  
**Date:** 2025-12-27 16:21:30  
**Hash:** 0c3311f0a2294e2aa97614a33afac7ebb18b40af  
**Summary:**  2 files changed, 14 insertions(+), 13 deletions(-)

### Files Changed

```
 src/main/java/com/embabel/guide/rag/DataManager.java  | 19 ++++++++++---------
 .../com/embabel/guide/rag/DataManagerController.java  |  8 ++++----
 2 files changed, 14 insertions(+), 13 deletions(-)
```

### File List

- **Modified:** `src/main/java/com/embabel/guide/rag/DataManager.java`
- **Modified:** `src/main/java/com/embabel/guide/rag/DataManagerController.java`

### Code Changes

```diff
diff --git a/src/main/java/com/embabel/guide/rag/DataManager.java b/src/main/java/com/embabel/guide/rag/DataManager.java
index c0077f0..a208bfd 100644
--- a/src/main/java/com/embabel/guide/rag/DataManager.java
+++ b/src/main/java/com/embabel/guide/rag/DataManager.java
@@ -4,7 +4,7 @@ import com.embabel.agent.api.common.LlmReference;
 import com.embabel.agent.api.common.reference.LlmReferenceProviders;
 import com.embabel.agent.api.identity.User;
 import com.embabel.agent.rag.ingestion.*;
-import com.embabel.agent.rag.store.ChunkingContentElementRepository;
+import com.embabel.agent.rag.neo.drivine.DrivineStore;
 import com.embabel.agent.tools.file.FileTools;
 import com.embabel.guide.GuideProperties;
 import com.google.common.collect.Iterables;
@@ -25,15 +25,16 @@ import java.util.List;
 @Service
 public class DataManager {
 
-    // TODO will be replaced with standard from ContentElementRepository
     public record Stats(
-            int chunks) {
+            int chunkCount,
+            int documentCount,
+            int contentElementCount) {
     }
 
     private final Logger logger = LoggerFactory.getLogger(DataManager.class);
     private final GuideProperties guideProperties;
     private final List<LlmReference> references;
-    private final ChunkingContentElementRepository store;
+    private final DrivineStore store;
 
     private final HierarchicalContentReader hierarchicalContentReader = new TikaHierarchicalContentReader();
 
@@ -43,7 +44,7 @@ public class DataManager {
     );
 
     public DataManager(
-            ChunkingContentElementRepository store,
+            DrivineStore store,
             GuideProperties guideProperties
     ) {
         this.store = store;
@@ -56,10 +57,10 @@ public class DataManager {
         }
     }
 
-//    public Stats getStats() {
-//        int chunkCount = store.count();
-//        return new Stats(chunkCount);
-//    }
+    public Stats getStats() {
+        var info = store.info();
+        return new Stats(info.getChunkCount(), info.getDocumentCount(), info.getContentElementCount());
+    }
 
     @NonNull
     public List<LlmReference> referencesForAllUsers() {
diff --git a/src/main/java/com/embabel/guide/rag/DataManagerController.java b/src/main/java/com/embabel/guide/rag/DataManagerController.java
index 5ec8b6b..f9cd4af 100644
--- a/src/main/java/com/embabel/guide/rag/DataManagerController.java
+++ b/src/main/java/com/embabel/guide/rag/DataManagerController.java
@@ -18,10 +18,10 @@ public class DataManagerController {
         this.dataManager = dataManager;
     }
 
-//    @GetMapping("/stats")
-//    public DataManager.Stats getStats() {
-//        return dataManager.getStats();
-//    }
+    @GetMapping("/stats")
+    public DataManager.Stats getStats() {
+        return dataManager.getStats();
+    }
 
     @PostMapping("/load-references")
     public String loadReferences() {
```

---


## Commit 8: 891c14f

**Message:** Build against updated drivine spring boot starter.  
**Author:** jasper blues <jasper@liberation-data.com>  
**Date:** 2025-12-27 15:09:25  
**Hash:** 891c14fb1a58c2c1fc2a8fd8c306c0d181a334fe  
**Summary:**  6 files changed, 62 insertions(+), 207 deletions(-)

### Files Changed

```
 .idea/jarRepositories.xml                          |   5 +
 pom.xml                                            |  19 ++--
 .../domain/drivine/DrivineGuideUserRepository.java |  32 +++---
 .../kotlin/com/embabel/guide/Neo4jTestContainer.kt | 109 ---------------------
 .../com/embabel/guide/TestApplicationContext.kt    |  83 ++++------------
 src/test/resources/application-test.yml            |  21 +++-
 6 files changed, 62 insertions(+), 207 deletions(-)
```

### File List

- **Modified:** `.idea/jarRepositories.xml`
- **Modified:** `pom.xml`
- **Modified:** `src/main/java/com/embabel/guide/domain/drivine/DrivineGuideUserRepository.java`
- **Deleted:** `src/test/kotlin/com/embabel/guide/Neo4jTestContainer.kt`
- **Modified:** `src/test/kotlin/com/embabel/guide/TestApplicationContext.kt`
- **Modified:** `src/test/resources/application-test.yml`

### Code Changes

```diff
diff --git a/.idea/jarRepositories.xml b/.idea/jarRepositories.xml
index 003cdc5..ca8da95 100644
--- a/.idea/jarRepositories.xml
+++ b/.idea/jarRepositories.xml
@@ -1,6 +1,11 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <project version="4">
   <component name="RemoteRepositoriesConfiguration">
+    <remote-repository>
+      <option name="id" value="google" />
+      <option name="name" value="google" />
+      <option name="url" value="https://maven.google.com/" />
+    </remote-repository>
     <remote-repository>
       <option name="id" value="embabel-snapshots" />
       <option name="name" value="embabel-snapshots" />
diff --git a/pom.xml b/pom.xml
index 44c6e65..0e37993 100644
--- a/pom.xml
+++ b/pom.xml
@@ -37,6 +37,13 @@
             <version>0.1.1-SNAPSHOT</version>
         </dependency>
 
+        <dependency>
+            <groupId>org.drivine</groupId>
+            <artifactId>drivine4j-spring-boot-starter</artifactId>
+            <version>0.0.5</version>
+        </dependency>
+
+
         <dependency>
             <groupId>com.embabel.agent</groupId>
             <artifactId>embabel-agent-starter-openai</artifactId>
@@ -150,17 +157,7 @@
             <scope>test</scope>
         </dependency>
 
-        <dependency>
-            <groupId>org.testcontainers</groupId>
-            <artifactId>neo4j</artifactId>
-            <scope>test</scope>
-        </dependency>
-
-        <dependency>
-            <groupId>org.testcontainers</groupId>
-            <artifactId>junit-jupiter</artifactId>
-            <scope>test</scope>
-        </dependency>
+        <!-- Testcontainers are now provided by drivine4j-spring-boot-starter via @EnableDrivineTestConfig -->
 
     </dependencies>
 
diff --git a/src/main/java/com/embabel/guide/domain/drivine/DrivineGuideUserRepository.java b/src/main/java/com/embabel/guide/domain/drivine/DrivineGuideUserRepository.java
index 519e342..c9b61cb 100644
--- a/src/main/java/com/embabel/guide/domain/drivine/DrivineGuideUserRepository.java
+++ b/src/main/java/com/embabel/guide/domain/drivine/DrivineGuideUserRepository.java
@@ -2,7 +2,6 @@ package com.embabel.guide.domain.drivine;
 
 import org.drivine.manager.PersistenceManager;
 import org.drivine.query.QuerySpecification;
-import org.drivine.utils.ObjectUtils;
 import org.springframework.beans.factory.annotation.Autowired;
 import org.springframework.beans.factory.annotation.Qualifier;
 import org.springframework.stereotype.Repository;
@@ -140,10 +139,8 @@ public class DrivineGuideUserRepository {
         return manager.getOne(
             QuerySpecification
                 .withStatement(cypher)
-                .bind(Map.of(
-                    "guideUserProps", ObjectUtils.primitiveProps(guideUserData),
-                    "discordProps", ObjectUtils.primitiveProps(discordUserInfo)
-                ))
+                .bindObject("guideUserProps", guideUserData)
+                .bindObject("discordProps", discordUserInfo)
                 .transform(GuideUserWithDiscordUserInfo.class)
         );
     }
@@ -153,7 +150,7 @@ public class DrivineGuideUserRepository {
      */
     @Transactional
     public GuideUserWithWebUser createWithWebUser(GuideUserData guideUserData,
-                                                   WebUserData webUserData) {
+                                                  WebUserData webUserData) {
         // Determine labels based on the WebUserData subtype
         String webUserLabels = webUserData instanceof AnonymousWebUserData
             ? "WebUser:Anonymous"
@@ -174,10 +171,8 @@ public class DrivineGuideUserRepository {
         return manager.getOne(
             QuerySpecification
                 .withStatement(cypher)
-                .bind(Map.of(
-                    "guideUserProps", ObjectUtils.primitiveProps(guideUserData),
-                    "webUserProps", ObjectUtils.primitiveProps(webUserData)
-                ))
+                .bindObject("guideUserProps", guideUserData)
+                .bindObject("webUserProps", webUserData)
                 .transform(GuideUserWithWebUser.class)
         );
     }
@@ -261,14 +256,11 @@ public class DrivineGuideUserRepository {
             SET u += props
             """;
 
-        Map<String, Object> props = ObjectUtils.primitiveProps(guideUser);
-
         manager.execute(
             QuerySpecification
                 .withStatement(cypher)
-                .bind(Map.of(
-                    "propsid", props
-                ))
+                .bindObject("props", guideUser)
+                .bind(Map.of("id", guideUser.getId()))
         );
 
         // Return the updated user
@@ -311,11 +303,11 @@ public class DrivineGuideUserRepository {
             """;
 
         return manager.query(
-            QuerySpecification
-                .withStatement(cypher)
-                .bind(Map.of())
-                .transform(Map.class)
-        ).stream()
+                QuerySpecification
+                    .withStatement(cypher)
+                    .bind(Map.of())
+                    .transform(Map.class)
+            ).stream()
             .map(mapper::mapToGuideUserComposite)
             .collect(Collectors.toList());
     }
diff --git a/src/test/kotlin/com/embabel/guide/Neo4jTestContainer.kt b/src/test/kotlin/com/embabel/guide/Neo4jTestContainer.kt
deleted file mode 100644
index 3c02581..0000000
--- a/src/test/kotlin/com/embabel/guide/Neo4jTestContainer.kt
+++ /dev/null
@@ -1,109 +0,0 @@
-/*
- * Copyright 2024-2025 Embabel Software, Inc.
- *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- * http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-package com.embabel.guide
-
-import org.testcontainers.containers.Neo4jContainer
-import java.nio.file.Paths
-
-class Neo4jTestContainer : Neo4jContainer<Neo4jTestContainer> {
-    private constructor(imageName: String) : super(imageName)
-
-    companion object {
-        /**
-         * Toggle between local Neo4j and TestContainers.
-         *
-         * Set environment variable USE_LOCAL_NEO4J=true to use local Neo4j
-         * (requires Neo4j running on localhost:7687).
-         *
-         * Default (unset or false): Uses TestContainers (slower startup, but fully isolated).
-         */
-        private val USE_LOCAL_NEO4J: Boolean = System.getenv("USE_LOCAL_NEO4J")?.toBoolean() ?: false
-
-        private const val LOCAL_NEO4J_URL = "bolt://localhost:7687"
-        private const val LOCAL_NEO4J_USERNAME = "neo4j"
-        private const val LOCAL_NEO4J_PASSWORD = "brahmsian"
-
-        @JvmField
-        val instance: Neo4jTestContainer? = if (USE_LOCAL_NEO4J) null else createTestContainer()
-
-        fun useLocalNeo4j(): Boolean {
-            return USE_LOCAL_NEO4J
-        }
-
-        fun getBoltUrl(): String {
-            return if (USE_LOCAL_NEO4J) {
-                LOCAL_NEO4J_URL
-            } else {
-                instance?.boltUrl ?: throw IllegalStateException("Neo4j test container not initialized")
-            }
-        }
-
-        fun getUsername(): String {
-            return if (USE_LOCAL_NEO4J) {
-                LOCAL_NEO4J_USERNAME
-            } else {
-                "neo4j"
-            }
-        }
```

---


*Note: Diff truncated (showing first 200 lines of 410 total)*


## Commit 9: f8cf750

**Message:** Upgrade to 0.3.1  
**Author:** Rod Johnson <johnsonroda@gmail.com>  
**Date:** 2025-12-25 09:35:34  
**Hash:** f8cf750c52121a6c7d108c4e44c2e472189ffc7d  
**Summary:**  4 files changed, 30 insertions(+), 14 deletions(-)

### Files Changed

```
 README.md                                       | 31 +++++++++++++++++++------
 pom.xml                                         |  2 +-
 src/main/java/com/embabel/GuideApplication.java |  6 -----
 src/main/resources/application.yml              |  5 ++++
 4 files changed, 30 insertions(+), 14 deletions(-)
```

### File List

- **Modified:** `README.md`
- **Modified:** `pom.xml`
- **Modified:** `src/main/java/com/embabel/GuideApplication.java`
- **Modified:** `src/main/resources/application.yml`

### Code Changes

```diff
diff --git a/README.md b/README.md
index 7a80a60..7740049 100644
--- a/README.md
+++ b/README.md
@@ -24,7 +24,8 @@ This is exposed in two ways:
 - Via an MCP server for integration with Claude Desktop, Claude Code and
   other MCP clients
 
-> **Note:** The chat server and Spring Shell conflict with each other. By default, the chat server is enabled. To use Spring Shell instead, uncomment the relevant lines in `pom.xml`.
+> **Note:** The chat server and Spring Shell conflict with each other. By default, the chat server is enabled. To use
+> Spring Shell instead, uncomment the relevant lines in `pom.xml`.
 
 ## Loading data
 
@@ -105,7 +106,9 @@ Add this stanza to `claude_desktop_config.json`:
 See [Connect Local Servers](https://modelcontextprotocol.io/docs/develop/connect-local-servers) for detailed
 documentation.
 
-You may also want to create a Project. See [claude_project.md](docs/claude_project.md) for suggested content.
+You should create a [Project](https://www.anthropic.com/news/projects) to ensure that Claude knows its purpose and how
+to use tools.
+See [claude_project.md](docs/claude_project.md) for suggested content.
 
 ### Claude Code
 
@@ -155,7 +158,13 @@ Example (recommended: use `mcp-remote` as a stdio bridge for SSE):
   "mcpServers": {
     "embabel-dev": {
       "command": "npx",
-      "args": ["-y", "mcp-remote", "http://localhost:1337/sse", "--transport", "sse-only"]
+      "args": [
+        "-y",
+        "mcp-remote",
+        "http://localhost:1337/sse",
+        "--transport",
+        "sse-only"
+      ]
     }
   }
 }
@@ -186,7 +195,13 @@ You should then see the MCP server listed with tools enabled:
   "mcpServers": {
     "embabel-dev": {
       "command": "npx",
-      "args": ["-y", "mcp-remote", "http://localhost:1337/sse", "--transport", "sse-only"]
+      "args": [
+        "-y",
+        "mcp-remote",
+        "http://localhost:1337/sse",
+        "--transport",
+        "sse-only"
+      ]
     }
   }
 }
@@ -207,7 +222,9 @@ https://antigravity.google/docs/mcp#connecting-custom-mcp-servers
     "embabel-dev": {
       "type": "sse",
       "url": "http://localhost:1337/sse",
-      "tools": ["*"]
+      "tools": [
+        "*"
+      ]
     }
   }
 }
@@ -423,7 +440,7 @@ docker compose down --remove-orphans
 ### Environment Variables
 
 | Variable           | Default                        | Description                                      |
-| ------------------ | ------------------------------ | ------------------------------------------------ |
+|--------------------|--------------------------------|--------------------------------------------------|
 | `COMPOSE_PROFILES` | `java`                         | Set to empty to run Neo4j only (no Java service) |
 | `NEO4J_VERSION`    | `2025.10.1-community-bullseye` | Neo4j Docker image tag                           |
 | `NEO4J_USERNAME`   | `neo4j`                        | Neo4j username                                   |
@@ -456,7 +473,7 @@ export OPENAI_API_KEY=sk-your-key-here
 The test suite uses Neo4j, which can be provided in two ways:
 
 | Mode                  | `USE_LOCAL_NEO4J` | How Neo4j is provided                       | Best for                           |
-| --------------------- | ----------------- | ------------------------------------------- | ---------------------------------- |
+|-----------------------|-------------------|---------------------------------------------|------------------------------------|
 | **CI (default)**      | unset/`false`     | Testcontainers spins up Neo4j automatically | GitHub Actions, fresh environments |
 | **Local development** | `true`            | You run Neo4j via Docker Compose            | Faster iteration                   |
 
diff --git a/pom.xml b/pom.xml
index d4cf7ae..44c6e65 100644
--- a/pom.xml
+++ b/pom.xml
@@ -18,7 +18,7 @@
 
     <properties>
         <java.version>21</java.version>
-        <embabel-agent.version>0.3.1-SNAPSHOT</embabel-agent.version>
+        <embabel-agent.version>0.3.1</embabel-agent.version>
         <kotlin.version>2.0.20</kotlin.version>
     </properties>
 
diff --git a/src/main/java/com/embabel/GuideApplication.java b/src/main/java/com/embabel/GuideApplication.java
index c466d67..d7f5eab 100644
--- a/src/main/java/com/embabel/GuideApplication.java
+++ b/src/main/java/com/embabel/GuideApplication.java
@@ -15,9 +15,6 @@
  */
 package com.embabel;
 
-import com.embabel.agent.config.annotation.EnableAgents;
-import com.embabel.agent.config.annotation.LoggingThemes;
-import com.embabel.agent.config.annotation.McpServers;
 import org.springframework.boot.SpringApplication;
 import org.springframework.boot.WebApplicationType;
 import org.springframework.boot.autoconfigure.SpringBootApplication;
@@ -28,9 +25,6 @@ import org.springframework.scheduling.annotation.EnableScheduling;
 @SpringBootApplication
 @ConfigurationPropertiesScan
 @EnableScheduling
-@EnableAgents(
-        loggingTheme = "starwars"
-)
 public class GuideApplication {
     public static void main(String[] args) {
         SpringApplication app = new SpringApplication(GuideApplication.class);
diff --git a/src/main/resources/application.yml b/src/main/resources/application.yml
index 6bd3bb2..452212a 100644
--- a/src/main/resources/application.yml
+++ b/src/main/resources/application.yml
@@ -64,6 +64,8 @@ embabel:
     default-llm: gpt-4.1-mini
 
   agent:
+
+
     rag:
       neo:
         uri: ${NEO4J_URI:bolt://localhost:7687}
@@ -72,6 +74,9 @@ embabel:
         max-chunk-size: 1500
         overlap-size: 200
 
+    logging:
+      personality: starwars
+
 
   discord:
     token: ${DISCORD_TOKEN}
```

---


## Commit 10: 85bc96e

**Message:** Merge pull request #19 from clojj/feature/readme-copilot-cli  
**Author:** Rod Johnson <johnsonroda@gmail.com>  
**Date:** 2025-12-25 10:00:37  
**Hash:** 85bc96e958b75c10c481ff5f5ee2d8a4bcfdc7e4  
**Summary:**  1 file changed, 3 insertions(+), 3 deletions(-)

### Files Changed

```
 README.md | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)
```

### File List


### Code Changes

```diff
```

---


---

## Instructions for AI Summary

Please provide a summary of the changes in the commits above. For each commit, explain:
1. The intent/purpose of the changes
2. Key parts of the code that were modified (what was adjusted and why)
3. Any important patterns, architectural decisions, or notable technical details

Focus on making the explanation clear and accessible, highlighting the most important changes.

